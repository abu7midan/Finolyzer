@page
@using Finolyzer.Localization
@using Finolyzer.Permissions
@using Finolyzer.Pages.CostSummaryRequests
@using Finolyzer.Services.Dtos.CostSummaryRequests
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Localization
@model ResultViewerModalModel
@inject IStringLocalizer<FinolyzerResource> L
@inject IAuthorizationService AuthorizationService

@{
    var result = Model.Result;
    Layout = null;

    string FormatSAR(double value) => $"{Math.Round(value, 2):N2} <span class=\"icon-saudi_riyal\">﷼</span>";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cost Summary Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .section-title {
            background-color: #f8f9fa;
            padding: 12px;
            margin-top: 40px;
            margin-bottom: 10px;
            border-left: 5px solid #0d6efd;
            font-size: 1.2rem;
        }

        .cost-table th, .cost-table td {
            vertical-align: middle;
            text-align: center;
        }

        .total-row {
            font-weight: bold;
            background-color: #f1f1f1;
        }

        .icon-saudi_riyal {
            font-weight: bold;
            font-family: Arial, sans-serif;
            margin-left: 2px;
        }

        @@media print {
            .print-button, .back-button

        {
            display: none;
        }

        body {
            margin: 0;
            font-size: 10pt;
        }

        .chart-card {
            page-break-before: always;
        }

        }
    </style>
</head>
<body class="container py-4">

    <div class="d-flex justify-content-end print-button mb-3">
        <button onclick="window.print()" class="btn btn-sm btn-outline-secondary me-2"><i class="fa fa-print"></i> Print</button>
    @*     <a href="@Url.Page("/PDF/ResultViewer", new { id = result.Id })" class="btn btn-sm btn-primary">
            <i class="fa fa-file-pdf"></i> Export PDF
        </a> *@
    </div>

    <h2 class="mb-4 text-center">📄 @L["Cost Summary Report"]</h2>

    <!-- Summary -->
    <div class="card border-primary shadow-sm">
        <div class="card-body">
            <div class="row mb-2"><div class="col-4 fw-bold">📌 Portfolio:</div><div class="col-8">@result.PortfolioName</div></div>
            <div class="row mb-2"><div class="col-4 fw-bold">🖥️ System:</div><div class="col-8">@result.SystemName</div></div>
            <div class="row mb-2"><div class="col-4 fw-bold">📅 Calculation Date:</div><div class="col-8">@result.CalculationBeforeDate.ToString("D")</div></div>
            <div class="row"><div class="col-4 fw-bold">🔁 Time Type:</div><div class="col-8">@result.TimlyRequestType</div></div>
        </div>
    </div>

    <!-- System Dependencies -->
    <div class="section-title">🔗 System Dependencies</div>
    <table class="table table-bordered cost-table table-sm">
        <thead class="table-light">
            <tr>
                <th>Type</th>
                <th>Name</th>
                <th>Provider</th>
                <th>Shared</th>
                <th>Share %</th>
                <th>Total Cost</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var d in result.SystemDependencies ?? Enumerable.Empty<CostSummarySystemDependencytDto>())
            {
                <tr>
                    <td>@d.DependencyType</td>
                    <td>@(d.ResourcenName ?? d.ProviderSubscriptionName ?? d.ServerName ?? "-")</td>
                    <td>@(d.ProviderName ?? "-")</td>
                    <td>@d.Shared</td>
                    <td>@d.SharePercentage</td>
                    <td>@Html.Raw(FormatSAR(d.TotalCost))</td>
                </tr>
            }
            <tr class="total-row">
                <td colspan="5">Total Dependency Cost</td>
                <td>@Html.Raw(FormatSAR(result.TotalSystemDependenciesCost))</td>
            </tr>
        </tbody>
    </table>

    <!-- Integration Transactions -->
    <div class="section-title">🔌 Integration Transactions</div>
    <table class="table table-bordered table-hover cost-table table-sm">
        <thead class="table-light">
            <tr>
                <th>Service</th>
                <th>Provider</th>
                <th>Shared</th>
                <th>Payment Type</th>
                <th>Share %</th>
                <th>Usage</th>
                <th>Total Cost</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var i in result.IntegrationTransactions ?? Enumerable.Empty<CostSummaryIntegrationTransactionDto>())
            {
                <tr>
                    <td>@i.ServiceName</td>
                    <td>@i.ProviderName</td>
                    <td>@i.Shared</td>
                    <td>@i.PaymentType?.Replace("%", "")</td>
                    <td>@i.SharePercentage</td>
                    <td>@i.TotalUsageCount</td>
                    <td>@Html.Raw(FormatSAR(i.TotalCost))</td>
                </tr>
            }
            <tr class="total-row">
                <td colspan="6">Total Integration Cost</td>
                <td>@Html.Raw(FormatSAR(result.TotalIntegrationTransactionsCost))</td>
            </tr>
        </tbody>
    </table>

    <!-- Shared Services -->
    <div class="section-title">🏢 Shared Services</div>
    <table class="table table-bordered cost-table table-sm">
        <thead class="table-light">
            <tr>
                <th>Name</th>
                <th>Provider</th>
                <th>Shared</th>
                <th>Share %</th>
                <th>Total Cost</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var s in result.SharedServices ?? Enumerable.Empty<CostSummarySharedServiceDto>())
            {
                <tr>
                    <td>@s.Name</td>
                    <td>@s.PorviderName</td>
                    <td>@s.Shared</td>
                    <td>@s.SharePercentage%</td>
                    <td>@Html.Raw(FormatSAR(s.TotalCost))</td>
                </tr>
            }
            <tr class="total-row">
                <td colspan="4">Total Shared Services Cost</td>
                <td>@Html.Raw(FormatSAR(result.TotalSharedServicesCost))</td>
            </tr>
        </tbody>
    </table>

    <!-- Grand Totals -->
    <div class="section-title">🧾 Grand Total</div>
    <table class="table table-bordered cost-table table-sm">
        <tbody>
            <tr>
                <td><strong>Total System Dependencies</strong></td>
                <td>@Html.Raw(FormatSAR(result.TotalSystemDependenciesCost))</td>
            </tr>
            <tr>
                <td><strong>Total Integration Transactions</strong></td>
                <td>@Html.Raw(FormatSAR(result.TotalIntegrationTransactionsCost))</td>
            </tr>
            <tr>
                <td><strong>Total Shared Services</strong></td>
                <td>@Html.Raw(FormatSAR(result.TotalSharedServicesCost))</td>
            </tr>
            <tr class="total-row">
                <td><strong>Grand Total</strong></td>
                <td><strong>@Html.Raw(FormatSAR(result.TotalCost))</strong></td>
            </tr>
        </tbody>
    </table>

    <!-- Chart -->
    <div class="section-title chart-card">📊 Cost Distribution Chart</div>
    <canvas id="costChart" width="400" height="200"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const ctx = document.getElementById('costChart');

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['System Dependencies', 'Integration Transactions', 'Shared Services'],
                datasets: [{
                    label: 'SAR Breakdown',
                    data: [
                        @result.TotalSystemDependenciesCost,
                        @result.TotalIntegrationTransactionsCost,
                        @result.TotalSharedServicesCost
                    ],
                    backgroundColor: [
                        '#0d6efd',
                        '#20c997',
                        '#ffc107'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    </script>
</body>
</html>